version: '3.8'

services:
  database:
    image: mongo
    volumes:
      - mongo-data:/data/db
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: example
    command: mongod --quiet --logpath /dev/null

  event-tracker:
    build: ./event-tracker
    depends_on:
      - database
    environment:
      MONGO_URI: "mongodb://root:example@database:27017"
    command: ./main

  game:
    build:
      context: ./game
    volumes:
      - game-dist:/dist
    command: >
      sh -c "rm -rf /dist/* &&
             cp -r /app/game/dist/* /dist &&
             ls -l /dist &&
             echo 'Copied files to /dist'"
  dashboard:
    build:
      context: ./dashboard
    volumes:
      - dashboard-dist:/dist
    command: >
      sh -c "rm -rf /dist/* &&
             cp -r /app/dashboard/dist/* /dist &&
             ls -l /dist &&
             echo 'Copied files to /dist'"

  webserver:
    build:
      context: ./nginx
    volumes:
      - game-dist:/usr/share/nginx/html/game:ro
      - dashboard-dist:/usr/share/nginx/html/dashboard:ro
    ports:
      - "3000:80"
      - "3001:81"
    depends_on:
      - game
      - dashboard
      - event-tracker

volumes:
  mongo-data:
  game-dist:
  dashboard-dist:
